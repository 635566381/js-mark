!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).textSelector=t()}(this,(function(){"use strict";var e;function t(n){for(var o=[],r=n.childNodes,i=0;i<r.length;i++){var a=r[i];a.nodeType!==e.TEXT_NODE?o.push.apply(o,t(a)):o.push(a)}return o}function n(e,n){for(var o=t(n),r=o.indexOf(e),i=0,a=0;a<r;a++)o[a]&&null!==o[a].nodeValue&&(i+=o[a].nodeValue.length);return i}function o(e,n){for(var o=null,r=0,i=t(e),a=0;a<i.length;a++)if(i[a]&&null!==i[a].nodeValue&&(r+=i[a].nodeValue.length),n<=r){o=i[a];break}return o}!function(e){e[e.ELEMENT_NODE=1]="ELEMENT_NODE",e[e.TEXT_NODE=3]="TEXT_NODE"}(e||(e={}));var r={isCover:!1};return function(){function e(e){var t,n;if(this._element=e.el,this._selection=window.getSelection(),1!==this._element.nodeType)throw new Error("\u8bf7\u6302\u8f7ddom\u8282\u70b9");if(!this._selection)throw new Error("\u6d4f\u89c8\u5668\u6682\u4e0d\u652f\u6301\u6807\u6ce8\uff0c\u8bf7\u67e5\u770b\u6587\u6863\u652f\u6301\u6d4f\u89c8\u5668\u7248\u672c");r.isCover=null!==(n=null===(t=null==e?void 0:e.options)||void 0===t?void 0:t.isCover)&&void 0!==n?n:r.isCover,this._onMouseUp=null,this._onClick=null,this._onSelected=null,this.onSelected=null,this.onClick=null,this._initEvent(),this._addEvent()}return e.prototype._initEvent=function(){var e=this;e._onMouseUp=function(t){e._captureSelection(void 0,t)},e._onClick=function(t){if(null!==t.target&&"dataset"in t.target){var n=t.target.dataset.selector;if(n){var o=document.querySelectorAll('span[data-selector="'+n+'"]');e.onClick&&e.onClick(o)}}},e._onSelected=function(e){this.onSelected&&this.onSelected({code:"string"==typeof e?-1:1,data:e}),"string"==typeof e&&console.error(e)}},e.prototype._addEvent=function(){this._element.addEventListener("mouseup",this._onMouseUp)},e.prototype._destroyEvent=function(){this._element.removeEventListener("mouseup",this._onMouseUp)},e.prototype.renderStore=function(e){var t=this;e.map((function(e){var r=o(t._element,e.offset+1),i=o(t._element,e.offset+e.text.length);i&&r&&t._captureSelection({collapsed:!1,commonAncestorContainer:t._element,endContainer:i,endOffset:e.offset+e.text.length-n(i,t._element),startContainer:r,startOffset:e.offset-n(r,t._element),other:e})}))},e.prototype._captureSelection=function(e,o){var i=this._selection;if(null!=i){var a=e||i.getRangeAt(0);if(a.collapsed)this._onClick&&this._onClick(o);else{var l={startContainer:a.startContainer,endContainer:a.endContainer,startOffset:a.startOffset,endOffset:a.endOffset};if(r.isCover&&l.startContainer!==l.endContainer){i.removeAllRanges();var s=l.endContainer.splitText(l.endOffset);l.endContainer=s.previousSibling,l.startContainer=l.startContainer.splitText(l.startOffset)}else{if(!r.isCover&&(l.startContainer.parentNode.dataset.selector||l.endContainer.parentNode.dataset.selector))return i.removeAllRanges(),this._onSelected&&this._onSelected("\u4e0d\u5141\u8bb8\u8986\u76d6\u6807\u6ce8\uff0c\u8be6\u7ec6\u8bf7\u770b\u914d\u7f6e\u6587\u6863\uff0c\u6216\u8bbe\u7f6eisCover\u4e3atrue");s=l.endContainer.splitText(l.endOffset);l.startContainer=l.startContainer.splitText(l.startOffset),l.endContainer=s.previousSibling}for(var d=t(a.commonAncestorContainer),f=n(l.startContainer,this._element),c=this.getSelectTextNode(d,l),u="",p=0;p<c.length;p++){u+=c[p].nodeValue}var h=!0;e||(h=!1,i.removeAllRanges()),this._onSelected&&this._onSelected({nodes:c,other:e&&e.other?e.other:{},text:u,offset:f,firstRender:h})}}},e.prototype.getSelectTextNode=function(e,t){var n=e.indexOf(t.startContainer),o=e.indexOf(t.endContainer);return e.filter((function(e,t){return n<=t&&o>=t}))},e.prototype.repaintRange=function(e,t,n){var o=t||"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)}));return e.forEach((function(e){if(e.parentNode){var t=document.createElement("span");t.className=n,t.setAttribute("data-selector",o),e.parentNode.replaceChild(t,e),t.appendChild(e)}})),t},e.prototype.clearRange=function(e){document.querySelectorAll('span[data-selector="'+e+'"]').forEach((function(e){if(e.parentNode){for(var t=document.createDocumentFragment(),n=e.childNodes,o=0;o<n.length;o++){var r=n[o];t.appendChild(r.cloneNode(!0))}e.parentNode.replaceChild(t,e)}}))},e}()}));
