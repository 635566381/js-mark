!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).textSelector=t()}(this,(function(){"use strict";var e;function t(n){for(var o=[],r=n.childNodes,i=0;i<r.length;i++){var s=r[i];s.nodeType!==e.TEXT_NODE?o.push.apply(o,t(s)):o.push(s)}return o}function n(e,n){for(var o=t(n),r=o.indexOf(e),i=0,s=0;s<r;s++)o[s]&&null!==o[s].nodeValue&&(i+=o[s].nodeValue.length);return i}function o(e,n){for(var o=null,r=0,i=t(e),s=0;s<i.length;s++)if(i[s]&&null!==i[s].nodeValue&&(r+=i[s].nodeValue.length),n<=r){o=i[s];break}return o}!function(e){e[e.ELEMENT_NODE=1]="ELEMENT_NODE",e[e.TEXT_NODE=3]="TEXT_NODE"}(e||(e={}));var r={isCover:!1};return function(){function e(e){var t,n;if(this.element=e.el,1!==this.element.nodeType)throw new Error("\u8bf7\u6302\u8f7ddom\u8282\u70b9");var o=e.options;null!==(t=null==o?void 0:o.isCover)&&void 0!==t&&t&&(r.isCover=null!==(n=null==o?void 0:o.isCover)&&void 0!==n?n:r.isCover),this.selection=window.getSelection(),this._mouseUp=null,this._click=null,this._selected=null,this.onSelected=null,this.onClick=null,this._initEvent()}return e.prototype._initEvent=function(){var e=this;this._mouseUp=function(t){e.captureSelection(void 0,t)},this._click=function(t){if(null!==t.target&&"dataset"in t.target){var n=t.target.dataset.selector;if(n){var o=document.querySelectorAll('span[data-selector="'+n+'"]');e.onClick&&e.onClick(o)}}},this._selected=function(e){this.onSelected&&this.onSelected({code:"string"==typeof e?-1:1,data:e}),"string"==typeof e&&console.error(e)},this.addEvent()},e.prototype.addEvent=function(){var e=this;this.element.addEventListener("mouseup",(function(t){e._mouseUp&&e._mouseUp(t)}))},e.prototype.destroyEvent=function(){var e=this;this.element.removeEventListener("mouseup",(function(t){e._mouseUp&&e._mouseUp(t)}))},e.prototype.fromStore=function(e){var t=this;e.map((function(e){var r=o(t.element,e.offset+1),i=o(t.element,e.offset+e.text.length);i&&r&&t.captureSelection({collapsed:!1,commonAncestorContainer:t.element,endContainer:i,endOffset:e.offset+e.text.length-n(i,t.element),startContainer:r,startOffset:e.offset-n(r,t.element),other:e})}))},e.prototype.captureSelection=function(e,o){var i=this.selection;if(null!=i){var s=e||i.getRangeAt(0);if(s.collapsed)this._click&&this._click(o);else{var a={startContainer:s.startContainer,endContainer:s.endContainer,startOffset:s.startOffset,endOffset:s.endOffset};if(r.isCover&&a.startContainer!==a.endContainer){i.removeAllRanges();var l=a.endContainer.splitText(a.endOffset);a.endContainer=l.previousSibling,a.startContainer=a.startContainer.splitText(a.startOffset)}else{if(!r.isCover&&(a.startContainer.parentNode.dataset.selector||a.endContainer.parentNode.dataset.selector))return i.removeAllRanges(),this._selected&&this._selected("\u4e0d\u5141\u8bb8\u8986\u76d6\u6807\u6ce8\uff0c\u8be6\u7ec6\u8bf7\u770b\u914d\u7f6e\u6587\u6863\uff0c\u6216\u8bbe\u7f6eisCover\u4e3atrue");l=a.endContainer.splitText(a.endOffset);a.startContainer=a.startContainer.splitText(a.startOffset),a.endContainer=l.previousSibling}for(var d=t(s.commonAncestorContainer),c=n(a.startContainer,this.element),f=this.getSelectTextNode(d,a),u="",p=0;p<f.length;p++){u+=f[p].nodeValue}var h=!0;e||(h=!1,i.removeAllRanges()),this._selected&&this._selected({nodes:f,other:e&&e.other?e.other:{},text:u,offset:c,firstRender:h})}}},e.prototype.getSelectTextNode=function(e,t){var n=e.indexOf(t.startContainer),o=e.indexOf(t.endContainer);return e.filter((function(e,t){return n<=t&&o>=t}))},e.prototype.repaintRange=function(e,t,n){var o=t||"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)}));return e.forEach((function(e){if(e.parentNode){var t=document.createElement("span");t.className=n,t.setAttribute("data-selector",o),e.parentNode.replaceChild(t,e),t.appendChild(e)}})),t},e.prototype.clearRange=function(e){document.querySelectorAll('span[data-selector="'+e+'"]').forEach((function(e){if(e.parentNode){for(var t=document.createDocumentFragment(),n=e.childNodes,o=0;o<n.length;o++){var r=n[o];t.appendChild(r.cloneNode(!0))}e.parentNode.replaceChild(t,e)}}))},e}()}));
